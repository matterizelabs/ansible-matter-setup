---
- name: Clone ESP-Matter
  ansible.builtin.git:
    repo: "{{ esp_matter_repo }}"
    dest: "{{ esp_install_dir_expanded }}/esp-matter"
    version: "{{ esp_matter_ref }}"
    depth: 1

- name: Initialize ESP-Matter submodules
  ansible.builtin.shell: |
    set -euo pipefail
    git submodule update --init --depth 1
  args:
    chdir: "{{ esp_install_dir_expanded }}/esp-matter"
    executable: /bin/bash
  when: not ansible_check_mode

- name: Checkout connectedhomeip submodules
  ansible.builtin.shell: |
    set -euo pipefail
    platform="{{ 'darwin' if ansible_facts['system'] == 'Darwin' else 'linux' }}"
    ./scripts/checkout_submodules.py --platform esp32 "$platform" --shallow
  args:
    chdir: "{{ esp_install_dir_expanded }}/esp-matter/connectedhomeip/connectedhomeip"
    executable: /bin/bash
  when: not ansible_check_mode

- name: Install ESP-Matter
  ansible.builtin.shell: |
    set -euo pipefail
    . "{{ esp_install_dir_expanded }}/esp-idf/export.sh"
    ./install.sh
  args:
    chdir: "{{ esp_install_dir_expanded }}/esp-matter"
    executable: /bin/bash
  environment:
    IDF_TOOLS_PATH: "{{ esp_idf_tools_path }}"
  when: not ansible_check_mode

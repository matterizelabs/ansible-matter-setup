---
- name: Install Android build packages (Debian/Ubuntu)
  become: true
  ansible.builtin.package:
    name:
      - unzip
      - openjdk-17-jdk
    state: present
  when: ansible_os_family == "Debian"

- name: Install Android build packages (RedHat/CentOS/Fedora)
  become: true
  ansible.builtin.package:
    name:
      - unzip
      - java-17-openjdk-devel
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Android build packages (Arch)
  become: true
  ansible.builtin.package:
    name:
      - unzip
      - jdk17-openjdk
    state: present
  when: ansible_os_family == "Archlinux"

- name: Fail on unsupported distro for Android packages
  ansible.builtin.fail:
    msg: "Unsupported distro for Android build dependencies. Please install JDK 17 and unzip manually."
  when: ansible_os_family not in ["Debian", "RedHat", "Archlinux"]

- name: Install Kotlin compiler
  become: true
  ansible.builtin.shell: |
    set -euo pipefail
    tmp_dir="$(mktemp -d)"
    kotlin_url="https://github.com/JetBrains/kotlin/releases/download/v{{ android_matter_kotlin_version }}/"
    kotlin_url="${kotlin_url}kotlin-compiler-{{ android_matter_kotlin_version }}.zip"
    wget -q -O "$tmp_dir/kotlin.zip" "$kotlin_url"
    rm -rf "{{ android_matter_kotlin_install_dir }}"
    unzip -q "$tmp_dir/kotlin.zip" -d /usr/lib
    rm -rf "$tmp_dir"
    rm -f "{{ android_matter_kotlin_install_dir }}/bin/"*.bat
  args:
    executable: /bin/bash
    creates: "{{ android_matter_kotlin_install_dir }}/bin/kotlinc"
  when: ansible_system == "Linux"

- name: Detect JAVA_HOME for Android builds
  ansible.builtin.command: readlink -f /usr/bin/java
  register: java_path
  changed_when: false
  failed_when: false
  when: ansible_system == "Linux"

- name: Set JAVA_HOME fact
  ansible.builtin.set_fact:
    android_matter_java_home: >-
      {{ (java_path.stdout | dirname | dirname) if (java_path.rc == 0) else '' }}
  when: ansible_system == "Linux"

- name: Detect sdkmanager
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ android_matter_sdk_root }}/cmdline-tools/latest/bin/sdkmanager"
    - "{{ android_matter_sdk_root }}/cmdline-tools/{{ android_matter_cmdline_tools_version }}/bin/sdkmanager"
  register: sdkmanager_stats
  when: ansible_system == "Linux"

- name: Select sdkmanager path
  ansible.builtin.set_fact:
    android_sdkmanager_path: >-
      {{ (sdkmanager_stats.results | selectattr('stat.exists') | map(attribute='item') | first) | default('') }}
  when: ansible_system == "Linux"

- name: Fail if sdkmanager is missing
  ansible.builtin.fail:
    msg: >-
      Android SDK Command Line Tools are required but were not found.
      Install Android Studio and the SDK Command Line Tools ({{ android_matter_cmdline_tools_version }})
      in {{ android_matter_sdk_root }}, then rerun this playbook.
  when: ansible_system == "Linux" and (android_sdkmanager_path | length == 0)

- name: Install Android SDK and NDK packages
  ansible.builtin.shell: |
    set -euo pipefail
    yes | "{{ android_sdkmanager_path }}" --licenses
    "{{ android_sdkmanager_path }}" --install \
      "platforms;android-{{ android_matter_sdk_api_level }}" "ndk;{{ android_matter_ndk_version }}"
  args:
    executable: /bin/bash
  environment:
    ANDROID_HOME: "{{ android_matter_sdk_root }}"
  when: ansible_system == "Linux"

- name: Write Android environment helper
  ansible.builtin.copy:
    dest: "{{ esp_install_dir_expanded }}/android-env.sh"
    mode: "0644"
    content: |
      export ANDROID_HOME="{{ android_matter_sdk_root }}"
      export ANDROID_NDK_HOME="{{ android_matter_sdk_root }}/ndk/{{ android_matter_ndk_version }}"
      export KOTLIN_HOME="{{ android_matter_kotlin_install_dir }}"
      export PATH="$PATH:{{ android_matter_kotlin_install_dir }}/bin:{{ android_matter_sdk_root }}/platform-tools:\
      {{ android_matter_sdk_root }}/cmdline-tools/latest/bin"
      {% if android_matter_java_home | length > 0 %}
      export JAVA_HOME="{{ android_matter_java_home }}"
      {% endif %}
  when: ansible_system == "Linux"

name: ci

"on":
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "**"

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      ansible: ${{ steps.filter.outputs.ansible }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ansible:
              - ".github/workflows/ci.yml"
              - "ansible.cfg"
              - ".ansible-lint"
              - ".yamllint"
              - ".pre-commit-config.yaml"
              - "playbook.yml"
              - "site.yml"
              - "group_vars/**"
              - "host_vars/**"
              - "inventory*.yml"
              - "roles/**"
              - "collections/**"
              - "scripts/**"
              - "pyproject.toml"

  lint:
    runs-on: ${{ matrix.os }}
    needs: [changes]
    if: needs.changes.outputs.ansible == 'true'
    concurrency:
      group: ci-${{ github.workflow }}-lint-${{ matrix.os }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint
      - name: Install collections
        run: ansible-galaxy collection install -r collections/requirements.yml
      - name: Run yamllint
        run: yamllint .
      - name: Run ansible-lint
        run: ansible-lint

  dry-run:
    runs-on: ${{ matrix.os }}
    needs: [changes]
    if: needs.changes.outputs.ansible == 'true'
    concurrency:
      group: ci-${{ github.workflow }}-dry-run-${{ matrix.os }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
      - name: Install collections
        run: ansible-galaxy collection install -r collections/requirements.yml
      - name: Dry run esp-idf and esp-matter
        run: ansible-playbook -i inventory.ci.yml site.yml --check --limit localhost --tags esp_idf,esp_matter

  ci:
    runs-on: ubuntu-latest
    needs: [changes, lint, dry-run]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          echo "changes=${{ needs.changes.result }}"
          echo "lint=${{ needs.lint.result }}"
          echo "dry-run=${{ needs.dry-run.result }}"
          if [ "${{ needs.lint.result }}" = "failure" ] || [ "${{ needs.dry-run.result }}" = "failure" ]; then
            exit 1
          fi

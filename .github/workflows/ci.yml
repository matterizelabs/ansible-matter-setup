name: ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  lint:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint
      - name: Install collections
        run: ansible-galaxy collection install -r collections/requirements.yml
      - name: Run yamllint
        run: yamllint .
      - name: Run ansible-lint
        run: ansible-lint

  dry-run:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
      - name: Install collections
        run: ansible-galaxy collection install -r collections/requirements.yml
      - name: Dry run esp-idf and esp-matter
        run: ansible-playbook -i inventory.ci.yml site.yml --check --limit localhost --tags esp_idf,esp_matter
